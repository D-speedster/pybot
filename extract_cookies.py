import os
import sys
import json
import sqlite3
import shutil
import browser_cookie3
import argparse
from pathlib import Path

def extract_cookies_from_browser(browser_name='chrome', domain='.youtube.com'):
    """Extract cookies from browser for a specific domain"""
    try:
        if browser_name.lower() == 'chrome':
            cookies = browser_cookie3.chrome(domain_name=domain)
        elif browser_name.lower() == 'firefox':
            cookies = browser_cookie3.firefox(domain_name=domain)
        elif browser_name.lower() == 'edge':
            cookies = browser_cookie3.edge(domain_name=domain)
        elif browser_name.lower() == 'opera':
            cookies = browser_cookie3.opera(domain_name=domain)
        elif browser_name.lower() == 'brave':
            cookies = browser_cookie3.brave(domain_name=domain)
        else:
            print(f"âŒ Ù…Ø±ÙˆØ±Ú¯Ø± {browser_name} Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
            return None
            
        return cookies
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§: {str(e)}")
        return None

def save_cookies_to_file(cookies, output_file='cookies.txt'):
    """Save cookies to Netscape format file for yt-dlp"""
    if not cookies:
        return False
        
    try:
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write("# Netscape HTTP Cookie File\n")
            f.write("# This file is generated by extract_cookies.py. Do not edit.\n\n")
            
            for cookie in cookies:
                secure = 'TRUE' if cookie.secure else 'FALSE'
                http_only = 'TRUE' if cookie.has_nonstandard_attr('HttpOnly') else 'FALSE'
                expires = int(cookie.expires) if cookie.expires else 0
                
                f.write(f"{cookie.domain}\t{cookie.domain.startswith('.')}\t{cookie.path}\t"
                       f"{secure}\t{expires}\t{cookie.name}\t{cookie.value}\n")
                       
        print(f"âœ… Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± ÙØ§ÛŒÙ„ {output_file} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.")
        return True
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§: {str(e)}")
        return False

def main():
    parser = argparse.ArgumentParser(description='Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± yt-dlp')
    parser.add_argument('--browser', '-b', default='chrome', 
                        choices=['chrome', 'firefox', 'edge', 'opera', 'brave'],
                        help='Ù†Ø§Ù… Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§')
    parser.add_argument('--domain', '-d', default='.youtube.com',
                        help='Ø¯Ø§Ù…Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§')
    parser.add_argument('--output', '-o', default='cookies.txt',
                        help='Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ')
    
    args = parser.parse_args()
    
    print(f"ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ÛŒ {args.domain} Ø§Ø² Ù…Ø±ÙˆØ±Ú¯Ø± {args.browser}...")
    cookies = extract_cookies_from_browser(args.browser, args.domain)
    
    if cookies:
        save_cookies_to_file(cookies, args.output)
        print("\nğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± yt-dlpØŒ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:")
        print(f"    yt-dlp --cookies {args.output} [URL]")
        print("\nğŸ’¡ ÛŒØ§ Ø¯Ø± Ú©Ø¯ Python:")
        print(f"    ydl_opts = {{'cookiefile': '{args.output}'}}")

if __name__ == "__main__":
    main()